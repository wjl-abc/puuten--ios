{% extends "profiles/base.html" %}

{% load i18n %}
{% load microblogging_tags %}

{% block head_title %}{% blocktrans %}Tweets{% endblocktrans %}{% endblock %}

{% block extra_head %}
    <link rel="alternate" type="application/atom+xml" title="Tweets Feed for User {{ user.username|capfirst }}" href="/feeds/tweets/only/{{ user.username }}/" />
    <link rel="alternate" type="application/atom+xml" title="Tweets Feed for User {{ user.username|capfirst }} and friends" href="/feeds/tweets/with_friends/{{ user.username }}/" />
{% endblock %}

{% block body %}
     <script type="text/javascript">
        $(document).ready(function(){
        	$('p:eq(2)').hide();
            $('p:eq(3)').hide(); 
            
            var map = initialize({{lat}},{{lng}},{{scale}});
            $('#id_latitude').val({{lat}});
            $('#id_longitude').val({{lng}});
    	    set_marker($('#id_latitude'), $('#id_longitude'), {{lat}},{{lng}}, map);
    	    
     });
    </script>
    <h1>{% trans "Tweets" %}</h1>
    
    {# @@@ can the publish to twitter checkbox actually be part of form and then we can use uni-form #}
    <form method="POST" action="">
        <p>{% trans "What are you doing?" %}</p>
        {{ form.as_p }}
        <p>
            <span id="chars_left"></span>
        </p>
        <div id="map_canvas" style="width:600px; height:500px"></div>
        {% if twitter_authorized %}
            <h2>{% trans "You have authorized a twitter account." %}</h2>
            <input name="pub2twitter" type="checkbox" id="pub2twitter" value="yes" />
            <label for="pub2twitter">{% trans "Publish to Twitter?" %}</label>
        {% endif %}

        <div class="form_block">
            <input type="hidden" name="next" value="create" />
            <input type="submit" value="{% trans 'Submit' %}" />
        </div>
    </form>
    
    {% if tweets %}
        <p>{% trans "These are tweets from the followings (plus your own):" %}</p>
        {% tweet_listing_for_tweet tweets 1 0 %}
    {% endif %}
    
{% endblock %}

{% block extra_body %}
    <script>
        $(document).ready(function() {
            function update_chars_left() {
                var max_len = 140;
                var textarea = $('#new_tweet')[0];
                var tweet_len = textarea.value.length;
                if (tweet_len >= max_len) {
                    textarea.value = textarea.value.substring(0, max_len); // truncate
                    $('#chars_left').html("0");
                } else {
                    $('#chars_left').html(max_len - tweet_len);
                }
            }
            $('#new_tweet').keyup(function() {
                update_chars_left();
            });
            update_chars_left();
            $('#new_tweet').focus();
            {% if reply %}
            var offset = {{ reply|length }} + 2;
            var textarea = $('#new_tweet')[0];
            if (textarea.setSelectionRange) { // Safari, Firefox
                textarea.setSelectionRange(offset, offset);
            } else if (textarea.createTextRange) { // IE
                var range = textarea.createTextRange();
                range.collapse(true);
                range.moveEnd('character', offset);
                range.moveStart('character', offset);
                range.select();
            }
            {% endif %}
        });
    </script>
{% endblock %}

